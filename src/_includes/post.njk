---
layout: base.njk
---

<article class="post">
  {% if image %}
    <div class="post-image-container">
      <img src="{{ image }}" alt="{{ title }}" class="post-image">
      {% if imageCredit %}
        <p class="image-credit">{{ imageCredit }}</p>
      {% endif %}
    </div>
  {% endif %}

  <header class="post-header">
    <div class="post-header-content">
      {% if tags and tags.length > 0 %}
      <span class="eyebrow">{{ tags[0] | formatTag }}</span>
      {% endif %}
      <h1 class="post-title">{{ title }}</h1>

      <div class="post-meta">
        <time datetime="{{ date | dateToFormat('yyyy-MM-dd') }}">{{ date | readableDate }}</time>
        <span class="post-meta-separator">•</span>
        <span class="post-reading-time">{{ content | readingTime }} min read</span>
      </div>

      {% if tags and tags.length > 1 %}
        <div class="post-tags">
          {% for tag in tags %}
            <a href="/topics/{{ tag | slugify }}/" class="tag">{{ tag | formatTag }}</a>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </header>

  {% set tocItems = content | generateTOC(title) %}

  <div class="post-layout">
    {% if tocItems.length > 0 %}
    <aside class="table-of-contents">
      <div class="toc-sticky">
        <h2 class="toc-title">Contents</h2>
        <nav class="toc-nav">
          <ul class="toc-list">
            {% for item in tocItems %}
            <li class="toc-item toc-level-{{ item.level }}">
              <a href="javascript:void(0)" class="toc-link" data-target="{{ item.id }}">{{ item.text }}</a>
            </li>
            {% endfor %}
          </ul>
        </nav>
      </div>
    </aside>
    {% endif %}

    <div class="post-content">
      {{ content | safe }}
    </div>
  </div>

  {%- if tags -%}
  {%- set relatedTools = [] -%}
  {%- for tag in tags -%}
    {%- if toolTopicMappings.topicToTools[tag] and toolTopicMappings.topicToTools[tag].length > 0 -%}
      {%- for toolId in toolTopicMappings.topicToTools[tag] -%}
        {%- if toolId not in relatedTools -%}
          {%- set relatedTools = (relatedTools.push(toolId), relatedTools) -%}
        {%- endif -%}
      {%- endfor -%}
    {%- endif -%}
  {%- endfor -%}

  {%- if relatedTools.length > 0 -%}
    {%- set toolId = relatedTools[0] -%}
    {%- set tool = toolTopicMappings.tools[toolId] -%}
    <div class="post-tool-cta" data-cta-type="tool" data-cta-tool="{{ toolId }}">
      <div class="post-tool-cta-content">
        <div class="post-tool-cta-text">
          <span class="eyebrow">Recommended Tool</span>
          <h3>{{ tool.name }}</h3>
          <p>{{ tool.description }}</p>
        </div>
        <a href="{{ tool.url }}" class="btn btn-primary">{{ tool.ctaText }}</a>
      </div>
    </div>
    {# Newsletter fallback when tool is completed #}
    <div class="post-subscribe-cta" data-cta-type="newsletter" data-cta-fallback="true" style="display: none;">
      {% set componentId = "post-" + (title | slugify) %}
      {% include "subscribe-block.njk" %}
    </div>
  {%- else -%}
    <div class="post-subscribe-cta" data-cta-type="newsletter">
      {% set componentId = "post-" + (title | slugify) %}
      {% include "subscribe-block.njk" %}
    </div>
  {%- endif -%}
  {%- endif -%}
</article>

{%- set relatedPostsData = collections.posts | relatedPosts(page.url, tags, 3) -%}
{%- if relatedPostsData.length > 0 -%}
<section class="related-posts">
  <div class="container-narrow">
    <div class="related-posts-header">
      <span class="eyebrow">Continue Reading</span>
      <h2>Related Articles</h2>
    </div>
  </div>
  <div class="container">
    <div class="articles-grid">
      {%- for item in relatedPostsData -%}
      {%- set relatedPost = item.post -%}
      <a href="{{ relatedPost.url }}" class="article-link">
        <article class="article-card">
          <div class="article-label">
            {% if relatedPost.data.tags and relatedPost.data.tags[0] %}
              {{ relatedPost.data.tags[0] | formatTag }}
            {% else %}
              Article
            {% endif %}
          </div>
          <h3 class="article-title">{{ relatedPost.data.title }}</h3>
          {% if relatedPost.data.preview %}
            <p class="article-excerpt">{{ relatedPost.data.preview | truncate(120) }}</p>
          {% elif relatedPost.data.description %}
            <p class="article-excerpt">{{ relatedPost.data.description | truncate(120) }}</p>
          {% endif %}
          <div class="article-meta">
            <time datetime="{{ relatedPost.date | dateToFormat('yyyy-MM-dd') }}" class="post-date">
              {{ relatedPost.date | readableDate }}
            </time>
          </div>
        </article>
      </a>
      {%- endfor -%}
    </div>
  </div>
</section>
{%- endif -%}

<div class="container-narrow">
  <nav class="post-nav">
    <a href="/articles/" class="btn btn-secondary">
      ← Back to Articles
    </a>
  </nav>
</div>

<script>
// Table of Contents Active Section Tracking
(function() {
  const tocLinks = document.querySelectorAll('.toc-link');
  if (tocLinks.length === 0) return;

  // Get all headings that are in the TOC
  const headings = Array.from(tocLinks).map(link => {
    const id = link.getAttribute('data-target');
    return document.getElementById(id);
  }).filter(heading => heading !== null);

  if (headings.length === 0) return;

  let currentActiveLink = null;
  const tocNav = document.querySelector('.toc-nav');

  function updateActiveLink() {
    const scrollPosition = window.scrollY + 100; // Offset for sticky header

    // Find the current section
    let currentHeading = null;
    for (let i = headings.length - 1; i >= 0; i--) {
      if (headings[i].offsetTop <= scrollPosition) {
        currentHeading = headings[i];
        break;
      }
    }

    if (!currentHeading && headings.length > 0) {
      currentHeading = headings[0];
    }

    // Update active state
    if (currentHeading) {
      const targetId = currentHeading.id;
      const newActiveLink = document.querySelector(`.toc-link[data-target="${targetId}"]`);

      if (newActiveLink !== currentActiveLink) {
        // Remove previous active
        if (currentActiveLink) {
          currentActiveLink.classList.remove('active');
        }

        // Add new active
        if (newActiveLink) {
          newActiveLink.classList.add('active');
          currentActiveLink = newActiveLink;

          // Auto-scroll TOC proactively to keep active item centered
          if (tocNav) {
            const linkOffset = newActiveLink.offsetTop - tocNav.offsetTop;
            const navHeight = tocNav.clientHeight;
            const currentScroll = tocNav.scrollTop;

            // Position the active item at about 1/3 from the top for better context
            const desiredScroll = linkOffset - (navHeight / 3);

            // Only scroll if the difference is significant (more than 20px)
            if (Math.abs(currentScroll - desiredScroll) > 20) {
              tocNav.scrollTo({
                top: Math.max(0, desiredScroll),
                behavior: 'smooth'
              });
            }
          }
        }
      }
    }
  }

  // Update on scroll
  let ticking = false;
  window.addEventListener('scroll', () => {
    if (!ticking) {
      window.requestAnimationFrame(() => {
        updateActiveLink();
        ticking = false;
      });
      ticking = true;
    }
  });

  // Update on load
  updateActiveLink();

  // Smooth scroll when clicking TOC links
  tocLinks.forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const targetId = link.getAttribute('data-target');
      const target = document.getElementById(targetId);
      if (target) {
        const targetPosition = target.getBoundingClientRect().top + window.pageYOffset;
        window.scrollTo({
          top: targetPosition - 100,
          behavior: 'smooth'
        });
      }
    });
  });
})();
</script>
